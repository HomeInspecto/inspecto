---
export const prerender = false;
import "../../../styles/style.css";

// const { reportID } = Astro.props;

const API_BASE_URL = "http://localhost:4000";

//http://localhost:4000/api/report/generate/

//a41bf1a8-03f0-4ec3-bc9d-1d1cc71a27ea

const { inspectionId } = Astro.params;

const res = await fetch(`${API_BASE_URL}/api/report/generate/${inspectionId}`);
const reportData = await res.json();

// For mock data fallback:
// import inspectionReport from "../../../../mock.json";
// const { organization, inspection } = reportData ?? inspectionReport;

const { organization, inspection } = reportData;



export interface Media {
  caption: string;
  url: string;
}

export interface Observation {
  name: string;
  severity: "minor" | "moderate" | "major";
  description: string;
  media?: Media[];
}

export interface Section {
  name: string;
  note: string;
  observations: Observation[];
}

export interface Inspection {
  summary: string;
  sections: Section[];
  created_at: string;
}

export interface Property {
  address: string;
  year_built?: number;
  type: string;
  sqft?: number;
  bedrooms?: number;
  bathrooms?: number;
  garage?: boolean;
  notes?: string;
}

export interface Inspector {
  name: string;
  email: string;
  phone: string;
}

export interface ContactInfo {
  phone?: string;
  address: string;
}

export interface Organization {
  name: string;
  logo?: string;
  website?: string;
  contact: ContactInfo;
  inspector: Inspector | null;
  properties: Property[];
}

export interface ReportData {
  organization: Organization;
  inspection: Inspection;
}
---

<body>
  <main class="report-container">
    <header class="report-header">
      {
        organization.logo && (
          <img
            src={organization.logo}
            alt={`${organization.name} logo`}
            class="logo"
          />
        )
      }
      <h1>{organization.name}</h1>

      <p><strong>Address:</strong> {organization.contact.address}</p>
      {
        organization.contact.phone && (
          <p>
            <strong>Phone:</strong> {organization.contact.phone}
          </p>
        )
      }

      {
        organization.website && (
          <p>
            <strong>Website:</strong>
            <a href={organization.website} target="_blank">
              {organization.website}
            </a>
          </p>
        )
      }

      <!-- ignoring inspector field for now -->
      <!-- {
        organization.inspector && (
          <>
            <h2>Inspector</h2>
            <p>{organization.inspector.name}</p>
            <p>{organization.inspector.email}</p>
            <p>{organization.inspector.phone}</p>
          </>
        )
      } -->

      <h2>Inspection Summary</h2>
      <p>{inspection.summary}</p>
      <p>
        <strong>Date:</strong>
        {new Date(inspection.created_at).toLocaleDateString()}
      </p>
    </header>

    {
      inspection.sections.map((section) => (
        <section class="section-card">
          <h2>{section.name}</h2>
          <p>{section.note}</p>

          {section.observations.length > 0 && (
            <div class="observations">
              {section.observations.map((obs) => (
                <div class="observation-card">
                  <h3>{obs.name}</h3>
                  <p>
                    <strong>Severity:</strong> {obs.severity}
                  </p>
                  <p>{obs.description}</p>

                  {obs.media && obs.media.length > 0 && (
                    <div class="media-gallery">
                      {obs.media.map((m) => (
                        <figure>
                          <img
                            src={m.url}
                            alt={m.caption}
                            class="media-photo"
                          />
                          <figcaption>{m.caption}</figcaption>
                        </figure>
                      ))}
                    </div>
                  )}
                </div>
              ))}
            </div>
          )}
        </section>
      ))
    }
  </main>
</body>
