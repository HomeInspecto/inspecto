---
import "../../../../styles/style.css";
export const prerender = false;

import ReportEditor from "../../../../components/ReportEditor.jsx";
import { decryptToken } from "../../../../utils/token-decryption";

const API_BASE_URL = import.meta.env.PUBLIC_API_URL || import.meta.env.API_URL || "http://localhost:4000";
const { inspectionId } = Astro.params;
const encryptedToken = Astro.url.searchParams.get("token");

// Decrypt the token if provided
let token: string | null = null;
if (encryptedToken) {
  try {
    token = decryptToken(encryptedToken);
  } catch (error) {
    console.error("Failed to decrypt token:", error);
    // If decryption fails, try using the token as-is (for backward compatibility)
    token = encryptedToken;
  }
}

// Fetch report data with authentication token if provided
const headers: HeadersInit = {
  "Content-Type": "application/json",
};

if (token) {
  headers["Authorization"] = `Bearer ${token}`;
}

const res = await fetch(`${API_BASE_URL}/api/report/generate/${inspectionId}`, {
  headers,
});

if (!res.ok) {
  throw new Error(`Failed to fetch report: ${res.status} ${res.statusText}`);
}

const reportData = await res.json();

const inspection = reportData.inspection;

const saveUrl = (fieldPath: string) =>
  `${API_BASE_URL}/api/report/update/${inspectionId}?field=${fieldPath}`;
---

<body>
  <main class="report-container" style="padding: 8px; max-width: 800px; margin: 0 auto;">
    
    <button
      style="margin-bottom: 8px; padding: 6px 10px;"
      onclick="window.location.href='http://localhost:4001/api/report/pdf/{{Astro.params.inspectionId}}';"
    >
      Download PDF
    </button>

    <h1 style="margin-bottom: 12px;">Inspection Editor</h1>
    <div class="center-block">

      {inspection?.inspector && (
        <section class="section-card" style="margin-bottom: 8px;">
          <h2 style="margin-bottom: 6px;"><strong>Inspector</strong></h2>
          <ReportEditor initialContent={inspection.inspector.name} saveUrl={saveUrl("inspector.name")} client:load />
          <ReportEditor initialContent={inspection.inspector.email} saveUrl={saveUrl("inspector.email")} client:load />
          <ReportEditor initialContent={inspection.inspector.phone} saveUrl={saveUrl("inspector.phone")} client:load />
          {inspection.inspector.license_number && (
            <ReportEditor initialContent={inspection.inspector.license_number} saveUrl={saveUrl("inspector.license_number")} client:load />
          )}
        </section>
      )}

      {inspection?.property && (
        <section class="section-card" style="margin-bottom: 8px;">
          <h2 style="margin-bottom: 6px;"><strong>Property</strong></h2>
          <ReportEditor initialContent={inspection.property.address ?? ""} saveUrl={saveUrl("property.address")} client:load />
          {inspection.property.year_built && (
            <ReportEditor initialContent={String(inspection.property.year_built)} saveUrl={saveUrl("property.year_built")} client:load />
          )}
          {inspection.property.type && (
            <ReportEditor initialContent={inspection.property.type} saveUrl={saveUrl("property.type")} client:load />
          )}
          {inspection.property.sqft && (
            <ReportEditor initialContent={String(inspection.property.sqft)} saveUrl={saveUrl("property.sqft")} client:load />
          )}
          {inspection.property.bedrooms && (
            <ReportEditor initialContent={String(inspection.property.bedrooms)} saveUrl={saveUrl("property.bedrooms")} client:load />
          )}
          {inspection.property.bathrooms && (
            <ReportEditor initialContent={String(inspection.property.bathrooms)} saveUrl={saveUrl("property.bathrooms")} client:load />
          )}
          {inspection.property.notes && (
            <ReportEditor initialContent={inspection.property.notes} saveUrl={saveUrl("property.notes")} client:load />
          )}
        </section>
      )}

      <section class="section-card" style="margin-bottom: 8px;">
        <h2 style="margin-bottom: 6px;"><strong>Inspection Summary</strong></h2>
        <ReportEditor initialContent={inspection.summary ?? ""} saveUrl={saveUrl("summary")} client:load />
        <p style="margin-top: 4px;"><strong>Date:</strong> {new Date(inspection.created_at).toLocaleDateString()}</p>
      </section>

    </div>

    {inspection.sections?.map((section, i) => (
      <section class="section-card" style="margin-bottom: 2px;">
        <div class="center-block" style="font-size: 26px; font-weight: bold; margin-top: 10px;">
          <ReportEditor
            initialContent={section.name}
            saveUrl={saveUrl(`sections.${i}.name`)}
            client:load
          />
        </div>

        {section.note && (
          <ReportEditor initialContent={section.note} saveUrl={saveUrl(`sections.${i}.note`)} client:load />
        )}

        {section.observations.map((obs, j) => (
          <div class="observation-card" style="margin-top: 6px; padding: 6px; border: 1px solid #ddd; border-radius: 6px;">
            <h3 style="margin-bottom: 4px;"><strong>Observation</strong></h3>
            <ReportEditor initialContent={obs.name} saveUrl={saveUrl(`sections.${i}.observations.${j}.name`)} client:load />

            <p style="margin: 4px 0;"><strong>Severity:</strong></p>
            <ReportEditor initialContent={obs.severity} saveUrl={saveUrl(`sections.${i}.observations.${j}.severity`)} client:load />

            <p style="margin: 4px 0;"><strong>Description:</strong></p>
            <ReportEditor initialContent={obs.description} saveUrl={saveUrl(`sections.${i}.observations.${j}.description`)} client:load />

            {obs.implication && (
              <>
                <p style="margin: 4px 0;"><strong>Implication:</strong></p>
                <ReportEditor initialContent={obs.implication} saveUrl={saveUrl(`sections.${i}.observations.${j}.implication`)} client:load />
              </>
            )}

            {obs.recommendation && (
              <>
                <p style="margin: 4px 0;"><strong>Recommendation:</strong></p>
                <ReportEditor initialContent={obs.recommendation} saveUrl={saveUrl(`sections.${i}.observations.${j}.recommendation`)} client:load />
              </>
            )}

            {obs.media && obs.media.length > 0 && (
              <div class="media-gallery" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 6px; justify-content: center;">
                {obs.media.map((m, k) => (
                  <figure style="flex: 1 1 100%; max-width: 500px; margin: 0 auto; display: flex; flex-direction: column; align-items: center;">
                    <img src={m.url} alt={m.caption ?? ""} style="width: 100%; max-height: 350px; object-fit: cover; border-radius: 6px;" />

                    <div style="width: 100%; max-width: 500px; margin-top: 4px;">
                      <ReportEditor
                        initialContent={m.caption ?? ""}
                        saveUrl={saveUrl(`sections.${i}.observations.${j}.media.${k}.caption`)}
                        client:load
                      />
                    </div>
                  </figure>
                ))}
              </div>
            )}
          </div>
        ))}
      </section>
    ))}
  </main>
</body>

